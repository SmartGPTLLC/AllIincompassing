# AGENTS.md – Operating Rules for Codex Agents

> **Scope** – These rules apply to *all* files under this repository. Any PR opened by an AI agent **must** respect the constraints below. Failures to comply will cause the CI pipeline to reject the change.  (See Codex system‑prompt spec ([baoyu.io](https://baoyu.io/blog/codex-system-prompt?utm_source=chatgpt.com)).)

---

## 📁 Directory‑level permissions

| Path                                                                    | May the agent modify? | Notes                                                                                                                                                               |
| ----------------------------------------------------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `/src/**`                                                               | **YES**               | Application code only. Follow code‑style rules below.                                                                                                               |
| `/supabase/migrations/**`                                               | **YES**               | Add/adjust SQL migrations generated by `supabase db diff --use-migrations` ([datacamp.com](https://www.datacamp.com/tutorial/openai-codex?utm_source=chatgpt.com)). |
| `/supabase/functions/**`                                                | **YES**               | Deploy with `supabase functions deploy --use-api` (no Docker) ([supabase.com](https://supabase.com/docs/guides/functions/deploy?utm_source=chatgpt.com)).           |
| `/docs/**`, `README.md`, `AGENTS.md`                                    | **YES**               | Keep docs in sync with code changes.                                                                                                                                |
| `.github/**`, `infra/**`, `Dockerfile`, `.env`, `.supabase/config.toml` | **NO**                | Infrastructure and secrets are human‑only; propose but never commit changes.                                                                                        |

---

## 🔑 Secrets & Environment

1. **Secrets live in Codex → Secrets**, never hard‑code or print them. Mask as `****` in logs ([datacamp.com](https://www.datacamp.com/tutorial/openai-codex?utm_source=chatgpt.com)).
2. Use the following env vars, already injected at runtime:
   - `SUPABASE_URL`, `SUPABASE_ANON_KEY` – read‑only client creds.
   - `SUPABASE_SERVICE_ROLE_KEY` – write/migration power.
   - `SUPABASE_ACCESS_TOKEN` – CLI auth token.
3. Generate Vite‑friendly keys in `.env` **during setup only**; do **not** commit `.env` to git.
4. Always run the Supabase CLI with `--project-ref wnnjeqheqxxyrgsjmygy` **or** ensure `.supabase/project.toml` contains that ref to avoid interactive prompts ([supabase.com](https://supabase.com/docs/reference/cli/start?utm_source=chatgpt.com)).
5. **Never** invoke Docker‑dependent commands (`supabase status`, `start`, `serve`, `db reset`) inside Codex—they fail without a Docker daemon ([baoyu.io](https://baoyu.io/blog/codex-system-prompt?utm_source=chatgpt.com)).

---

## 🏗️ Coding‑standards

- **TypeScript / React** – follow Airbnb style via project ESLint + Prettier settings ([gist.github.com](https://gist.github.com/ruvnet/ba1497632143ea9f12062c9c2c1879ad?utm_source=chatgpt.com)).
- **Exports** – use **named exports**; no default exports.
- **Testing** – every logic change needs a Jest test; run `npm test`, `eslint .`, and `tsc --noEmit` before opening a PR ([datacamp.com](https://www.datacamp.com/tutorial/openai-codex?utm_source=chatgpt.com)).
- **Commits** – use Conventional Commits (`feat(scope): summary`) ([gist.github.com](https://gist.github.com/ruvnet/ba1497632143ea9f12062c9c2c1879ad?utm_source=chatgpt.com)).
- **Coverage** – maintain ≥ 90 % line coverage; CI fails below this threshold.

---

## 🗄️ Database & Migrations

1. **Create migrations locally** with `supabase migration new` or via `db diff --use-migrations` ([datacamp.com](https://www.datacamp.com/tutorial/openai-codex?utm_source=chatgpt.com)).
2. **Apply migrations** with `supabase db push -p wnnjeqheqxxyrgsjmygy` (cloud‑only).
3. After every push, **regenerate types**:
   ```bash
   supabase gen types typescript \
     --schema public \
     -p wnnjeqheqxxyrgsjmygy \
     > src/lib/generated/database.types.ts
   ```
4. Ensure **Row‑Level Security** is enabled on new tables and at least one policy allows the intended access ([docs.supabase.com](https://docs.supabase.com/?utm_source=chatgpt.com)).

---

## 🚦 CI Gate

The CI pipeline will:

1. Re‑run the setup script (see `/scripts/setup.sh`).
2. Enforce lint, tests, type‑check.
3. Reject PRs touching forbidden paths or failing any step.

---

## 🤖 Pull‑Request template the agent must use

```
### Summary
<one‑sentence overview>

### Proposed changes
- Bullet 1
- Bullet 2

### Tests added/updated
- jest/path/to/test.ts

### Checklist
- [ ] `npm test` passed
- [ ] `eslint .` passed
- [ ] `tsc --noEmit` passed
- [ ] Supabase types regenerated
```

PR body rules sourced from Codex docs on AGENTS.md PR‑guidance ([baoyu.io](https://baoyu.io/blog/codex-system-prompt?utm_source=chatgpt.com)).

---

## 📜 Changelog

- **v1.0 (2025‑06‑23)** – Initial agent guidelines drafted from OpenAI Codex best‑practices and Supabase CLI docs ([agentsmd.net](https://agentsmd.net/?utm_source=chatgpt.com), [supabase.com](https://supabase.com/docs/guides/functions/deploy?utm_source=chatgpt.com), [baoyu.io](https://baoyu.io/blog/codex-system-prompt?utm_source=chatgpt.com), [github.com](https://github.com/orgs/supabase/discussions/12639?utm_source=chatgpt.com)).

